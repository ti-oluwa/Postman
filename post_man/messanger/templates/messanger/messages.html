{% extends 'messanger/base.html' %}
{% load static %}
{% load custom_filters %}
{% block title %}
    <title>Postman | {{ request.user | title }}'s Messages</title>
{% endblock title %}

<!-- <link rel="stylesheet" href="{% static 'messanger/main.css' %}"> -->
<!-- <link rel="stylesheet" href="../../static/messanger/main.css"> -->

{% block styles %}
    <link rel="stylesheet" href="{% static 'messanger/message.css' %}">
{% endblock styles %}


    {% block content %}
        <!-- loading animation -->
        <div class="anim_container">
            <span>Postman</span>
            <div class="lds-ellipsis"><div></div><div></div><div></div><div></div></div>
            <p>Loading messages...</p>
        </div>

        <div class="be_container">

            <div class="page_lead">
                <div class="head">
                    <h1>Messages</h1>
                    <p>Messages you sent</p>
                </div>
                <button class="create_btn">
                    <p>New SMS</p>
                    <img src="{% static 'images/message.svg' %}" alt="">
                </button>
            </div>
            <div class="border_btm"></div>
            
            <div class="no_messages">
                <p>No messages yet</p>
                <img src="{% static 'images/folder.svg' %}" alt="">
            </div>

            <div class="messages">
                {% if text_messages %} 
                    <div class="select_all">
                        <div>
                            <input id="select_all" type="checkbox" value="all">
                            <label for="select_all">Select all</label>
                        </div>
                        <p>Delete</p>
                    </div>
                    {% for message in text_messages %}
                        <div class="message">
                            {% if message.is_sent %}
                            <div class="message_summary">
                            {% elif not message.is_sent and not message.is_draft %} 
                            <div class="message_summary failed_message">
                            {% elif not message.is_sent and message.is_draft %} 
                            <div class="message_summary drafted_message" id="{{ message.id }}">
                            {% endif %}  
                                <input id="{{ message.id }}" type="checkbox" value="{{ message.id }}">
                                <div>
                                    {% if message.is_sent %}
                                        {% if message.sent_to.all|length == 1 %}
                                            {% for number in message.sent_to.all %}
                                                <h3>Sent to {{ number }}</h3>
                                            {% endfor %}
                                        {% elif message.sent_to.all|length  > 1 and message.sent_to.all|length < message.sent_by.added_phone_numbers.all|length %}
                                            <h3>Sent to {{ message.sent_to.all | length }} contact{{ message.sent_to.all | length | pluralize }}</h3>
                                        {% elif message.sent_to.all|length == message.sent_by.added_phone_numbers.all|length %}
                                            <h3>Sent to all contacts</h3>
                                        {%  endif %}
                                    {% elif not message.is_sent and not message.is_draft %}
                                        {% if message.send_to.all|length == 1 %}
                                            {% for number in message.send_to.all %}
                                                <h3>Failed to send to {{ number }}</h3>
                                            {% endfor %}
                                        {% elif message.send_to.all|length  > 1 and message.send_to.all|length < message.sent_by.added_phone_numbers.all|length %}
                                            <h3>Failed to send to {{ message.send_to.all | length }} contact{{ message.send_to.all | length | pluralize }}</h3>
                                        {% elif message.send_to.all|length == message.sent_by.added_phone_numbers.all|length %}
                                            <h3>Failed to send to all contacts</h3>
                                        {%  endif %}
                                    {% elif not message.is_sent and message.is_draft %}
                                        {% if message.send_to.all|length == 1 %}
                                            {% for number in message.send_to.all %}
                                                <h3>To be sent to {{ number }}</h3>
                                            {% endfor %}
                                        {% elif message.send_to.all|length  > 1 and message.send_to.all|length < message.sent_by.added_phone_numbers.all|length %}
                                            <h3>To be sent to {{ message.send_to.all | length }} contact{{ message.send_to.all | length | pluralize }}</h3>
                                        {% elif message.send_to.all|length == message.sent_by.added_phone_numbers.all|length %}
                                            <h3>To be sent to all contacts</h3>
                                        {%  endif %}
                                    {% endif %}
                                    <p>
                                        {% if message.is_sent %}
                                            {{ message.date_sent|mytimesincer }}
                                        {% else %}
                                            {{ message.date_created|mytimesincer }}
                                        {% endif %}
                                    </p>
                                </div>
                                <p class="succinct">{{ message.message | truncatewords:10 }}.</p>
                            </div>
                            <div class="message_content">
                                <p>{{ message.message | linebreaks | urlize }}</p>
                                <p id="minor">
                                {% if message.sent_to.all|length  > 0 and message.is_sent %}
                                    <a>See recipients</a> - 
                                {% elif message.sent_to.all|length == 0 and not message.is_sent and not message.is_draft %}
                                    <a style="color: coral !important;">See recipients</a> - 
                                {% elif message.sent_to.all|length == 0 and not message.is_sent and not message.is_draft %}
                                    <a style="color: #888 !important;">See recipients</a> - 
                                {% endif %}
                                {{ message.date_sent| time:'H:i' }}</p>
                                <div class="retry_del">
                                    {% if not message.is_sent and not message.is_draft %}
                                        <span><a href="{% url 'retry' %}?type=sms&&pk={{message.id}}">retry</a></span>
                                    {% elif not message.is_sent and message.is_draft %}
                                        <span><a href="{% url 'retry' %}?type=sms&&pk={{message.id}}">send</a></span>
                                        <span><a style="color: #888 !important;" id="{{message.id}}" class="edit_draft">edit</a></span>
                                    {% endif %}
                                    <span id="del_btn">delete</span>
                                </div>
                            </div>
                            {% if message.sent_to.all|length  >= 0 and message.is_sent %}
                                <div class="recipients">
                                    <div>
                                        <h3>Sent to - {{ message.sent_to.all | length }}</h3>
                                        <img src="{% static 'images/previous.svg' %}" alt="">
                                    </div>
                                    <ul>
                                        {% for recipient in message.sent_to.all %}
                                            <li>{{ recipient }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% elif message.sent_to.all|length == 0 and not message.is_sent %}
                                <div class="recipients">
                                    <div>
                                        {% if not message.is_draft %}
                                            <h3 style="color: #555 !important;">Failed to send to - {{ message.send_to.all | length }}</h3>
                                        {% elif message.is_draft %}
                                            <h3 style="color: #555 !important;">To be sent to - {{ message.send_to.all | length }}</h3>
                                        {% endif %}
                                        <img src="{% static 'images/previous.svg' %}" alt="">
                                    </div>
                                    <ul>
                                        {% for recipient in message.send_to.all %}
                                            {% if not message.is_draft %}
                                                <li style="color: hsl(39, 78%, 80%) !important;">{{ recipient }}</li>
                                            {% elif message.is_draft %}
                                                <li style="color: #999 !important;">{{ recipient }}</li>
                                            {% endif %}
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% endif %}

            </div>

            <button class="create_btn_hover">
                <p>New SMS</p>
                <img src="{% static 'images/message.svg' %}" alt="">
            </button>

        </div>

        <div class="contact_popup">
            <div class="pill"></div>
            <div class="popup_head">
                <p>Send to</p>
                <img src="{% static 'images/cancel.svg' %}" alt="">
            </div>
            <div class="popup_body">

                <form id="add_form" method="post" enctype="multipart/form-data" class="add_contact">
                    <div>
                        <img src="{% static 'images/add-user.svg' %}" alt="">
                        <label for="phone_no">Add phone numbers</label>
                    </div>
                    <input type="tel" name="phone_number" id="phone_no" pattern="^(?:\+(?:[0-9] ?){10,14}[0-9](, ?)?)+$" placeholder="+23409...">
                    <label for="phone_no_file">Select file (*.txt, *.csv)[max-1MB]</label>
                    <div class="file_name">
                        <p>No file selected</p>
                    </div>
                    <input type="file" name="file" id="phone_no_file" accept=".txt, .csv">
                    
                    <div class="help">
                        <div>
                            <img src="{% static 'images/info2.svg' %}" alt="">
                            <p>Info</p>
                        </div>
                        <p class="text">
                            The phone number(s) you enter should conform with the E.164 number plan! If there are multiple numbers, separate them with a comma.
                            You can upload a file containing phone numbers you want to send to. It is advisable that the files contain only text (phone numbers) and 
                            that they're separated with commas, newlines or any of these [':', ';', '-'] delimiters.
                        </p>
                    </div>
                    <button id="done" disabled>
                        <p>Proceed</p>
                        <img src="{% static 'images/check1.svg' %}" alt="">
                    </button>
                </form>

                <form id="select_form" method="post" class="select">
                    <div class="no_contact">
                        <p>No contacts yet</p>
                        <img src="{% static 'images/empty2.svg' %}" alt="">
                    </div>
                    <div class="all">
                        <input type="checkbox" name="all" id="all">
                        <div class="check_mark"></div>
                        <label for="all">Select all</label>
                    </div>
                    {% if phone_numbers %}
                        {% for phone_number in phone_numbers %}
                            <div class="contact">
                                <input type="checkbox" name="contact" id="{{ phone_number.number.as_e164 }}" value="{{ phone_number.number.as_e164 }}">
                                <div class="check_mark"></div>
                                <label for="{{ phone_number.number.as_e164 }}">{{ phone_number.number.as_e164 }}</label>
                            </div>
                        {% endfor %}
                    {% endif %}
                </form>
            </div>
        </div>

        <form action="" id="message_form" method="post" class="message_popup">
            {% csrf_token %}
            <label for="message">Enter message</label>
            <p class="help_text"></p>
            <div>
                <textarea id="message" placeholder="Enter message here" required maxlength="160" minlength="10" title="Type in your message" autofocus></textarea>
                <img id="send_btn" src="{% static 'images/send2.svg' %}" alt="send">
            </div>
            <p id="draft">Save as draft</p>
        </form>

        <div class="confirm_send_popup">
            <img class="image" src="{% static 'images/mail-confirm.svg' %}" alt="confirm">
            <p>Just to be sure</p>
            <div class="btns">
                <div class="yes">
                    <img src="{% static 'images/tick.svg' %}" alt="">
                </div>
                <div class="no">
                    <img src="{% static 'images/cancel.svg' %}" alt="">
                </div>
            </div>
        </div>

        <div class="sending_popup">
            <img class="image" src="{% static 'images/sending.gif' %}" alt="confirm">
            <p>Sending SMS</p>
        </div>

        <div class="jump_page">
            <img src="{% static 'images/up-right-arrow.svg' %}" alt="">
        </div>

        {% if messages %}
            <!-- notifications -->
            <div class="notification_icon">
                <img src="{% static 'images/bell-ring.svg' %}" alt="">
                {% if messages %}
                    <span>{{ messages|length }}</span>
                {% endif %}
            </div>
            <div class="notifications">
                <img id="sub_icon" src="{% static 'images/bell.svg' %}" alt="" style="width: 30px; height: 30px;">
                {% for message in messages %}
                    {% if 'info' in message.tags %}
                        <div class="toast info">
                            <img src="{% static 'images/info2.svg' %}" alt="" style="width: 20px; height: 20px;">
                            <p>{{ message|showHTML5 }}</p>
                        </div>
                    {% elif  'success' in message.tags %}
                        <div class="toast success">
                            <img src="{% static 'images/tick.svg' %}" alt="" style="width: 20px; height: 20px;">
                            <p>{{ message|showHTML5 }}</p>
                        </div>
                    {% elif  'error' in message.tags %}
                        <div class="toast error">
                            <img src="{% static 'images/cancel.svg' %}" alt="" style="width: 20px; height: 20px;">
                            <p>{{ message|showHTML5 }}</p>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        {% endif %}

    {% endblock content %}

{% block script %}
<script src="{% static 'messanger/jquery-3.6.1.min.js' %}"></script>
<script type="text/javascript">
    function returnFileSize(number) {
        if (number < 1024) {
          return `${number} bytes`;
        } else if (number >= 1024 && number < 1048576) {
          return `${(number / 1024).toFixed(1)} KB`;
        } else if (number >= 1048576) {
          return `${(number / 1048576).toFixed(1)} MB`;
        };
    };

    function fileSizeDoesNotExceed(file_size, max_file_size){
        if (file_size > max_file_size){
            return false;
        }
        return true;
    }

    document.onreadystatechange = () => {
        if (document.readyState !== "complete"){
            document.querySelector('.anim_container').classList.add('show_loader');
            document.querySelector('body').classList.add('stop_scroll');
            document.querySelector('.lds-ellipsis').querySelectorAll('div').forEach(div => {
                div.classList.add('play');
            })
        }
        else{
            setTimeout(() => {
                document.querySelector('.anim_container').classList.remove('show_loader');
                document.querySelector('body').classList.remove('stop_scroll');
                document.querySelector('.lds-ellipsis').querySelectorAll('div').forEach(div => {
                    div.classList.remove('play');
                })
            }, 300);
            
        };
    };

    
    // shows and hides header and create button on scroll
    var oldScrollPosition = 0;
    window.onscroll = (e) => {
        var scrollPosition = document.documentElement.scrollTop;
        if (scrollPosition >= window.innerHeight * 0.2 && scrollPosition > oldScrollPosition) {
            document.querySelector('header').classList.add('hide');
            document.querySelector('.create_btn_hover').classList.add('show_hover_btn');
            oldScrollPosition = scrollPosition       
        }
        else{
            document.querySelector('header').classList.remove('hide');
            document.querySelector('.create_btn_hover').classList.remove('show_hover_btn');
            oldScrollPosition = scrollPosition;
        };


        if (document.querySelector('.be_container').clientHeight > window.innerHeight){
            // shows and hides jump page button on scroll
            document.querySelector('.jump_page').classList.add('show_jump_page');
            if (scrollPosition > document.querySelector('.be_container').clientHeight * 0.2) {
                setTimeout(() => {
                    document.querySelector('.jump_page').classList.remove('show_jump_page');
                }, 3000);
                document.querySelector('.jump_page').classList.add('change_direction');
                document.querySelector('.jump_page').addEventListener('click', () => {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                });
            }
            else{
                document.querySelector('.jump_page').classList.remove('change_direction');
                setTimeout(() => {
                    document.querySelector('.jump_page').classList.remove('show_jump_page');
                }, 3000);
                document.querySelector('.jump_page').addEventListener('click', () => {
                    window.scrollTo({
                        top: window.innerHeight,
                        behavior: 'smooth'
                    });
                });
            };
        };
    }


    window.onload = () => {

        if(window.location.href.endsWith('?send')){
            setTimeout(() => { 
                document.querySelector('.contact_popup').classList.add('contact_popup_open');
                document.querySelector('body').classList.toggle('stop_scroll');
                document.querySelectorAll('button').forEach(button => {
                    if(button.id != 'done'){
                        button.disabled = true;
                        button.style.pointerEvents = "none";
                    };
                });
            }, 500)
        }

        // scroll to last edited draft
        if (document.querySelector('.drafted_message')){
            var drafts = document.querySelectorAll('.drafted_message');
            var last_saved_draft_id = '{{ request.session.last_save_request_sms_draft_id }}';
            var last_edited_draft_id = '{{ request.session.last_edit_request_sms_draft_id }}';
            if (last_saved_draft_id == last_edited_draft_id){
                drafts.forEach(draft => {
                    if (draft.id == last_saved_draft_id){
                        draft.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                        draft.parentElement.querySelector('.message_summary').click();
                    };
                });
            };
            
        };

        // adds event listener to the scroll button
        document.querySelector('.jump_page').addEventListener('click', () => {
            window.scrollTo({
                top: document.querySelector('.be_container').clientHeight,
                behavior: 'smooth'
            });
        });

        // opens notifications shade
        if (document.querySelector('.notifications')){
            document.querySelector('.notification_icon').querySelector('img').classList.add('blink_img');
            document.querySelector('.notification_icon').classList.add('blink_icon');
            document.querySelector('.notification_icon').addEventListener('click', () => {
                document.querySelector('.notification_icon').querySelector('img').classList.remove('blink_img');
                document.querySelector('.notification_icon').classList.remove('blink_icon');
                document.querySelector('.notifications').classList.toggle('open_shade');
            })
        }

        const messages = document.querySelectorAll('.message');
        var contacts = document.querySelectorAll('.contact');
        // var show_delay = 0.2;
        // const observer = new IntersectionObserver((entries) => {
        //     entries.forEach(entry => {
        //         if (entry.isIntersecting){
        //             entry.target.classList.add('show_messages');
        //         }
        //     })
        // });
        // messages.forEach((message) => {
        //     observer.observe(message);
        //     message.style.animationDelay = `${show_delay}s`;
        //     show_delay += 0.1;
        // });

        // setTimeout(() => {
        //     messages.forEach((message) => {
        //         message.style.animationDelay = '0.2s';
        //     });
        // }, 1000);

        if (messages.length != 0) {
            // messages[0].scrollIntoView();

            // shows and hides message content
            messages.forEach(message => {
                message.querySelector('.message_summary').addEventListener('click', (e) => {
                    if (!document.querySelector('.contact_popup').classList.contains('contact_popup_open') && !document.querySelector('.message_popup').classList.contains('show_message_popup') && !message.querySelector('input').contains(e.target)) {   
                        message.querySelector('.message_content').classList.toggle('message_content_open');
                        message.querySelector('.message_summary').classList.toggle('adjust_border');
                        message.querySelector('.message_content').querySelectorAll('p').forEach(p => {
                            p.classList.toggle('show');
                        })
                        message.querySelector('.message_content').querySelectorAll('div').forEach(div => {
                            div.classList.toggle('show_2');
                        })
                    }; 
                });

                if (message.querySelector('#minor').querySelector('a')){
                    message.querySelector('#minor').querySelector('a').addEventListener('click', () => {
                        message.querySelector('.recipients').classList.add('show_recipients');
                        document.querySelector('body').classList.add('stop_scroll');

                        message.querySelector('.recipients').querySelector('img').addEventListener('click', () => {
                            message.querySelector('.recipients').classList.remove('show_recipients');
                            document.querySelector('body').classList.remove('stop_scroll');
                        });   
                    });
                };

            });

            

            // shows and hides contact popup
            [document.querySelector('.create_btn'), document.querySelector('.create_btn_hover')].forEach(create_btn =>{
                create_btn.addEventListener('click', () => {
                    document.querySelector('.contact_popup').classList.add('contact_popup_open');
                    document.querySelector('body').classList.toggle('stop_scroll');
                    document.querySelectorAll('button').forEach(button => {
                        if(button.id != 'done'){
                            button.disabled = true;
                            button.style.pointerEvents = "none";
                        };
                    });
                });
            })
            document.querySelector('.contact_popup').querySelector('img').addEventListener('click', () => {
                document.querySelector('.contact_popup').classList.remove('contact_popup_open');
                document.querySelector('body').classList.toggle('stop_scroll');
                document.querySelectorAll('button').forEach(button => {
                    button.disabled = false;
                    button.style.pointerEvents = "auto";
                });
            });
        }
        else{
            // shows no messages
            document.querySelector('.no_messages').classList.add('show_no_messages');
        }
        
        // shows and hides contact popup
        [document.querySelector('.create_btn'), document.querySelector('.create_btn_hover')].forEach(create_btn =>{
            create_btn.addEventListener('click', () => {
                document.querySelector('.contact_popup').classList.add('contact_popup_open');
                document.querySelector('body').classList.add('stop_scroll');
                document.querySelectorAll('button').forEach(button => {
                    if(button.id != 'done'){
                        button.disabled = true;
                        button.style.pointerEvents = "none";
                    };
                });
            });
        })
        document.querySelector('.contact_popup').querySelector('img').addEventListener('click', () => {
            document.querySelector('.contact_popup').classList.remove('contact_popup_open');
            document.querySelector('body').classList.remove('stop_scroll');
            document.querySelectorAll('form').forEach(form => {
                form.reset();
                document.querySelector('.file_name').querySelector('p').innerText = 'No file selected';
            });
            document.querySelectorAll('button').forEach(button => {
                button.disabled = false;
                button.style.pointerEvents = "auto";
            });
        });

        if (contacts.length != 0) {
            // removes no contacts message
            document.querySelector('.no_contact').classList.remove('show_no_contact')
            // ticks select all input
            document.querySelector('.all').querySelector('.check_mark').addEventListener('click', () => {
                document.querySelector('.all').querySelector('input').checked = false;
            });
            //unticks select all input
            document.querySelector('.all').querySelector('input').addEventListener('click', () => {
                document.querySelector('.all').querySelector('input').checked = true;
            });
            // ticks and unticks all checkbox based on select all input value
            [document.querySelector('.all').querySelector('input'), document.querySelector('.all').querySelector('.check_mark')].forEach( item => {
                item.addEventListener('click', () => {
                    contacts.forEach(contact => {
                        contact.querySelector('input').checked = document.querySelector('.all').querySelector('input').checked;
                    })
                })
            });

            // unticks checkbox
            contacts.forEach(contact => {
                contact.querySelector('.check_mark').addEventListener('click', () => {
                    contact.querySelector('input').checked = false;
                    //unticks and ticks select all checkbox if all contacts are ticked or unticked
                    var unticked = [];
                    contacts.forEach(contact => {
                        unticked.push(contact.querySelector('input').checked)
                    });
                    if (unticked.some(e => e == false) == true) {
                        document.querySelector('.all').querySelector('input').checked = false;
                    }
                    else if(unticked.some(e => e == false) == false){
                        document.querySelector('.all').querySelector('input').checked = true;
                    }
                });
            })
            //ticks checkbox
            contacts.forEach(contact => {
                contact.querySelector('input').addEventListener('click', () => {
                    contact.querySelector('input').checked = true;
                    //unticks and ticks all's checkbox if all contacts are ticked or unticked
                    var unticked = [];
                    contacts.forEach(contact => {
                        unticked.push(contact.querySelector('input').checked)
                    });
                    if (unticked.some(e => e == false) == true) {
                        document.querySelector('.all').querySelector('input').checked = false;
                    }
                    else if(unticked.some(e => e == false) == false){
                        document.querySelector('.all').querySelector('input').checked = true;
                    };
                });
            });

            // events related to the contact popup
            document.querySelector('.popup_body').addEventListener('pointerover', () => {
                var addInputs = document.querySelector('.add_contact').querySelectorAll('input');
                var selectInputs = document.querySelector('.select').querySelectorAll('input');
                var proceedButton = document.querySelector('#done');
                var falseValues = [];
                var empty = true;
                // returns all false fields in the checkbox fields
                selectInputs.forEach(input => {
                    if(input.checked == false){
                        falseValues.push(input)
                    }
                });
                //set the value of var empty based on the text and file input fields 
                if (addInputs[0].value != ''){
                    empty = false
                }
                if (addInputs[1].files.length != 0){
                    empty = false
                }
                // enables and disables the proceed button based on the value of var empty and falseValues
                // checks if all check boxes are unchecked and all text and file fields are empty and disables or enables the proceed button
                if (falseValues.length == selectInputs.length){
                    if (empty == true){
                        proceedButton.disabled = true;
                        proceedButton.style.pointerEvents = 'none';
                    }
                    else{
                        if (document.querySelector('#phone_no').checkValidity() != true){
                            document.querySelector('#phone_no').style.borderColor = 'hsla(0, 61%, 70%, 0.8)';
                            proceedButton.disabled = true;
                            proceedButton.style.pointerEvents = 'none';
                        }
                        else{
                            document.querySelector('#phone_no').style.borderColor = 'hsla(120, 61%, 70%, 0.8)';
                            proceedButton.disabled = false;
                            proceedButton.style.pointerEvents = 'auto';
                        };

                        if(document.querySelector('#phone_no_file').files.length != 0){
                            var file_name = document.querySelector('#phone_no_file').files[0].name;
                            var file_type = document.querySelector('#phone_no_file').files[0].type;
                            var file_size_int = document.querySelector('#phone_no_file').files[0].size;
                            var file_size = returnFileSize(file_size_int);
                            document.querySelector('.file_name').querySelector('p').innerText = file_name + ' (' + file_size + ')';
                            if (fileSizeDoesNotExceed(file_size_int, 1048576) && (file_type == 'text/plain' || file_type == 'text/csv')){
                                proceedButton.disabled = false;
                                proceedButton.style.pointerEvents = 'auto';
                            }
                            else{
                                proceedButton.disabled = true;
                                proceedButton.style.pointerEvents = 'none';
                                document.querySelector('.file_name').style.backgroundColor = 'hsla(0, 61%, 70%, 0.8)';
                                document.querySelector('#phone_no_file').addEventListener('click', ()=> {
                                    document.querySelector('.file_name').style.backgroundColor = '';
                                });
                            };
                        };
                    };
                    if (document.querySelector('#phone_no').value == ''){
                        document.querySelector('#phone_no').style.borderColor = '';
                    };

                }

                else{
                    proceedButton.disabled = false;
                    proceedButton.style.pointerEvents = 'auto';

                    if (empty == false){
                        if (document.querySelector('#phone_no').checkValidity() != true){
                            document.querySelector('#phone_no').style.borderColor = 'hsla(0, 61%, 70%, 0.8)';
                            proceedButton.disabled = true;
                            proceedButton.style.pointerEvents = 'none';
                        }
                        else{
                            document.querySelector('#phone_no').style.borderColor = 'hsla(120, 61%, 70%, 0.8)';
                            proceedButton.disabled = false;
                            proceedButton.style.pointerEvents = 'auto';
                        };

                        if(document.querySelector('#phone_no_file').files.length != 0){
                            var file_name = document.querySelector('#phone_no_file').files[0].name;
                            var file_size_int = document.querySelector('#phone_no_file').files[0].size;
                            var file_type = document.querySelector('#phone_no_file').files[0].type;
                            var file_size = returnFileSize(file_size_int);
                            document.querySelector('.file_name').querySelector('p').innerText = file_name + ' (' + file_size + ')';
                            if (fileSizeDoesNotExceed(file_size_int, 1048576) && (file_type == 'text/plain' || file_type == 'text/csv')){
                                proceedButton.disabled = false;
                                proceedButton.style.pointerEvents = 'auto';
                            }
                            else{
                                proceedButton.disabled=true;
                                proceedButton.style.pointerEvents='none';
                                document.querySelector('.file_name').style.backgroundColor = 'hsla(0, 61%, 70%, 0.8)';
                                document.querySelector('#phone_no_file').addEventListener('click', ()=> {
                                    document.querySelector('.file_name').style.backgroundColor = '';
                                });
                            };
                        };
                    }
                        
                    if (document.querySelector('#phone_no').value == ''){
                        document.querySelector('#phone_no').style.borderColor = '';
                    };
                };
            });

        }
        else{
            // shows no contacts message
            document.querySelector('.all').style.display = 'none';
            document.querySelector('.no_contact').classList.add('show_no_contact')

            // events related to the contact popup
            document.querySelector('.popup_body').addEventListener('pointerover', () => {
                var addInputs = document.querySelector('.add_contact').querySelectorAll('input');
                var proceedButton = document.querySelector('#done');
                var empty = true;
                
                //set the value of var empty based on the text and file input fields 
                if (addInputs[0].value != ''){
                    empty = false
                }
                if (addInputs[1].files.length != 0){
                    empty = false
                }
                // checks text and file fields are empty and disables or enables the proceed button
                if (empty == true){
                    proceedButton.disabled = true;
                    proceedButton.style.pointerEvents = 'none';
                }
                else{
                    
                    if (document.querySelector('#phone_no').checkValidity() != true){
                        document.querySelector('#phone_no').style.borderColor = 'hsla(0, 61%, 70%, 0.8)';
                        proceedButton.disabled = true;
                        proceedButton.style.pointerEvents = 'none';
                    }
                    else{
                        document.querySelector('#phone_no').style.borderColor = 'hsla(120, 61%, 70%, 0.8)';
                        proceedButton.disabled = false;
                        proceedButton.style.pointerEvents = 'auto';
                    };

                    if(document.querySelector('#phone_no_file').files.length != 0){
                        var file_name = document.querySelector('#phone_no_file').files[0].name;
                        var file_size_int = document.querySelector('#phone_no_file').files[0].size;
                        var file_type = document.querySelector('#phone_no_file').files[0].type;
                        var file_size = returnFileSize(file_size_int);
                        document.querySelector('.file_name').querySelector('p').innerText = file_name + ' (' + file_size + ')';
                        if (fileSizeDoesNotExceed(file_size_int, 1048576) && (file_type == 'text/plain' || file_type == 'text/csv')){
                            proceedButton.disabled = false;
                            proceedButton.style.pointerEvents = 'auto';
                        }
                        else{
                            proceedButton.disabled = true;
                            proceedButton.style.pointerEvents = 'none';
                            document.querySelector('.file_name').style.backgroundColor = 'hsla(0, 61%, 70%, 0.8)';
                            document.querySelector('#phone_no_file').addEventListener('click', ()=> {
                                document.querySelector('.file_name').style.backgroundColor = '';
                            });
                        };
                    };
                };

                if (document.querySelector('#phone_no').value == ''){
                    document.querySelector('#phone_no').style.borderColor = '';
                };
            });
        }

    };

    window.onclick = (event) => {

        if (document.querySelector('.menu_icon').contains(event.target)){
            document.querySelector('.menu').classList.toggle('show_menu');
        }
        else if (!document.querySelector('.menu').contains(event.target) && !document.querySelector('.menu_icon').contains(event.target)){
            document.querySelector('.menu').classList.remove('show_menu');
        }

        var messages = document.querySelectorAll('.message');
        // close notification shade on outside click
        if(document.querySelector('.notifications') && !document.querySelector('.notification_icon').contains(event.target) && !document.querySelector('.notifications').contains(event.target) && document.querySelector('.notifications').classList.contains('open_shade')){
            document.querySelector('.notifications').classList.remove('open_shade')
        }

        document.querySelector('#done').addEventListener('click', (e) => {
            e.stopPropagation();
            e.preventDefault();
            document.querySelector('.contact_popup').classList.remove('contact_popup_open');
            document.querySelector('body').classList.remove('stop_scroll');
            setTimeout(() => {
                document.querySelector('.message_popup').classList.add('show_message_popup');
            }, 500);
            document.querySelectorAll('button').forEach(button => {
                button.disabled = true;
                button.style.pointerEvents = "none";
            });
        });

        if (!document.querySelector('.message_popup').contains(event.target) && document.querySelector('.message_popup').classList.contains('show_message_popup') 
            && !document.querySelector('.confirm_send_popup').contains(event.target) && !document.querySelector('.confirm_send_popup').classList.contains('show_confirm_send_popup')) {
            document.querySelector('.message_popup').classList.add('remove_message_popup');
            document.querySelector('.message_popup').classList.remove('show_message_popup');
            setTimeout(() => {
                document.querySelector('.message_popup').querySelector('#draft').innerText = 'Save as draft';
                document.querySelector('.message_popup').querySelector('#send_btn').style.display = 'block';
                document.querySelector('.message_popup').querySelector('label[for=message]').innerText = 'Enter message';
            }, 500);
            document.querySelectorAll('form').forEach(form => {
                form.reset();
                document.querySelector('.file_name').querySelector('p').innerText = 'No file selected';
            });
            document.querySelectorAll('button').forEach(button => {
                button.disabled = false;
                button.style.pointerEvents = "auto";
            });
        };

        messages.forEach(message => {
            if(message.querySelector('#minor').querySelector('a') && !message.querySelector('#minor').querySelector('a').contains(event.target) 
                && !message.querySelector('.recipients').contains(event.target) && message.querySelector('.recipients').classList.contains('show_recipients')){
                message.querySelector('.recipients').classList.remove('show_recipients');
                document.querySelector('body').classList.remove('stop_scroll');
            };

            if(message.querySelector('.edit_draft') && message.querySelector('.edit_draft').contains(event.target)){
                $.ajax({
                    url: '{% url "edit-draft" %}',
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        'draft_id': message.querySelector('.edit_draft').id,
                        'object_type': 'sms',
                    },
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    success: function(response){
                        if (response['success'] == 'true'){
                            document.querySelector('.message_popup').querySelector('#draft').innerText = 'Save draft';
                            document.querySelector('.message_popup').querySelector('#send_btn').style.display = 'none';
                            document.querySelector('.message_popup').querySelector('label[for=message]').innerText = 'Edit draft';
                            document.querySelector('.message_popup').querySelector('#message').value = response['data']['message'];
                            document.querySelector('.message_popup').classList.add('show_message_popup');
                        }
                        else if(response['success'] == 'false'){
                            console.log(response['error']);
                        }
                    },
                });
            };

        });

        
        if (document.querySelector('.select_all')){
            // ticks select all message delete checkbox based on select all checkbox
            document.querySelector('.select_all').querySelector('input').addEventListener('change', () => {
                messages.forEach(message => {
                    message.querySelector('input').checked = document.querySelector('.select_all').querySelector('input').checked;
                });
            });

            // what to do on finalizing delete choice
            document.querySelector('.select_all').querySelector('p').addEventListener('click', (e) => {
                e.stopImmediatePropagation()
                payload = {
                    'object_type': 'sms',
                    'object_list': [],
                };
                // gets the value of the checked inputs for delete
                messages.forEach(message => {
                    if(message.querySelector('input').checked){
                        payload['object_list'].push(message.querySelector('input').value)
                    }
                });
                data = new FormData();
                data.append('payload', JSON.stringify(payload));

                $.ajax({
                    url: '{% url "delete" %}',
                    method: 'POST',
                    cache: false,
                    contentType: false,
                    processData: false,
                    dataType: 'json',
                    data: data,
                    headers:{
                        'X-CSRFToken': getCookie("csrftoken"),
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    success: function (response){
                        if(response['message'] == "success" || "error"){
                            window.location.reload()
                        };
                    },
                });
            });

        };
        

        messages.forEach(message => {
            // related to deleting messages
            message.querySelector('#del_btn').addEventListener('click', () => {
                message.querySelector('input').checked = true;
                document.querySelector('.select_all').classList.add('show_2');
                messages.forEach(message =>{
                    message.querySelector('input').classList.add('show');
                });
            });

            // unticks and ticks select all  based on the number of checked boxes
            [message.querySelector('input'), document.querySelector('.select_all').querySelector('input')].forEach(input =>{
                input.addEventListener('change', () => {
                    //unticks and ticks select all checkbox if all contacts are ticked or unticked
                    var ticked = [];
                    messages.forEach(message => {
                        ticked.push(message.querySelector('input').checked)
                    });
                    if (ticked.some(e => e == false) == true) {
                        document.querySelector('.select_all').querySelector('input').checked = false;
                    }
                    else if(ticked.some(e => e == false) == false){
                        document.querySelector('.select_all').querySelector('input').checked = true;
                    }
                    if (ticked.every(e => e == false) == true){
                        message.querySelector('input').checked = true;
                        document.querySelector('.select_all').classList.remove('show_2');
                        messages.forEach(message =>{
                            message.querySelector('input').classList.remove('show');
                        });
                    }
                });
            });
        });

        var message_field = document.querySelector('#message');

        function send(){
            // checks if the message is valid
            payload = new FormData();
            payload.append('message', message_field.value)
            $.ajax({
                url: '{% url "validate-message" %}',
                method: 'POST',
                cache: false,
                dataType: 'json',
                contentType: false,
                processData: false,
                data: payload,
                headers:{
                    'X-CSRFToken': getCookie("csrftoken"),
                    'X-Requested-With': 'XMLHttpRequest',
                },
                success: function (response){
                    if(response['message'] == "success"){
                        message_field.style.borderColor = '';
                        document.querySelector('.help_text').style.display = 'none';
                        document.querySelector('#message').title = 'Type in your message';
                        document.querySelector('.help_text').innerText = '';
                    }
                    else if(response['message'] == "error"){
                        document.querySelector('.help_text').style.display = 'block';
                        document.querySelector('#message').title = 'Message should not contain the words above';
                        document.querySelector('.help_text').innerText = 'Blacklisted words found!: ' + response['bad_words'];
                        message_field.style.borderColor = 'hsla(0, 61%, 70%, 0.8)';
                    }
                },
            });
        };

        
        var sendAfter = 200;
        message_field.addEventListener('keyup', (e) => {
            e.stopImmediatePropagation()
            clearTimeout(timeout);
            var timeout = setTimeout(send, sendAfter);
            
            setTimeout(() => {
                var message = document.querySelector('#message').value;
                if (message != '' && message.length >= 10 && message.length <= 160){
                    document.querySelector('#draft').style.pointerEvents = 'auto';
                    if(document.querySelector('.help_text').style.display != 'none'){
                        document.querySelector('#draft').style.pointerEvents = 'none';
                    };
                }
                else{
                    document.querySelector('#draft').style.pointerEvents = 'none';
                }; 
            }, sendAfter * 2)
        });

        
        document.querySelector('#send_btn').addEventListener('click', (e) => {
            var message = document.querySelector('#message').value;
            if (message != '' && message.length >= 10 && message.length <= 160){
                if(document.querySelector('.help_text').style.display != 'none'){
                    document.querySelector('#message_form').querySelector('label').innerText = 'Remove blacklisted words';
                    document.querySelector('#message_form').querySelector('label').style.color = 'hsla(0, 61%, 70%, 0.8)';
                    setTimeout(() => {
                        document.querySelector('#message_form').querySelector('label').innerText = 'Enter message';
                        document.querySelector('#message_form').querySelector('label').style.color = '';
                        document.querySelector('#message').title = 'Type in your message';
                    }, 3000);
                    document.querySelector('#message').title = 'Message should not contain the words above';
                }else{
                document.querySelector('.confirm_send_popup').classList.add('show_confirm_send_popup');
                document.querySelector('body').classList.add('stop_scroll');
                };
            }
            else{
                document.querySelector('#message_form').querySelector('label').innerText = 'Message should be 10 and 160 characters long';
                document.querySelector('#message_form').querySelector('label').style.color = 'hsla(0, 61%, 70%, 0.8)';
                setTimeout(() => {
                    document.querySelector('#message_form').querySelector('label').innerText = 'Enter message';
                    document.querySelector('#message_form').querySelector('label').style.color = '';
                    document.querySelector('#message').title = 'Type in your message';
                }, 3000);
                document.querySelector('#message').title = 'Message must be between 10 and 160 characters long';
                document.querySelector('#message').style.borderColor = 'hsla(0, 61%, 70%, 0.8)';
                document.querySelector('#message').addEventListener('input', () => {
                    document.querySelector('#message').placeholder = 'Enter message';
                    document.querySelector('#message').style.borderColor = '#ccc';
                });
            }; 
        });


        document.querySelector('#draft').addEventListener('click', (e) =>{
            e.stopImmediatePropagation();
            
            var addFormData = {
                'phone_numbers': document.querySelector('#phone_no').value,
            };
            var selected_contacts = [];
            document.querySelectorAll('.contact').forEach(contact => {
                if (contact.querySelector('input').checked == true){
                    selected_contacts.push(contact.querySelector('input').value);
                };
            });
            var selectFormData = {
                'all_contacts': document.querySelector('#all').checked,
                'selected_contacts': selected_contacts,
            };
            var messageFormData = {
                'message': document.querySelector('#message').value,
            };
            var payload = {
                'addFormData': addFormData,
                'selectFormData': selectFormData,
                'messageFormData': messageFormData,
                'action': 'save_message_draft',
            };

            var file = document.querySelector('#phone_no_file').files[0];
            var formData = new FormData();
            formData.append('file', file);
            formData.append('payload', JSON.stringify(payload))
            
            // sends data for message to be sent
            $.ajax({
                url: '{% url "send" %}',
                method: 'POST',
                contentType: false,
                dataType: 'json',
                data: formData,
                processData: false,
                cache: false,
                headers: {
                    'X-CSRFToken': getCookie("csrftoken"),
                    'X-Requested-With': 'XMLHttpRequest',
                },
                success: function(data){
                    if (data['success'] == 'true' || 'false'){
                        document.querySelector('.message_popup').classList.add('remove_message_popup');
                        document.querySelector('.message_popup').classList.remove('show_message_popup');
        
                        setTimeout(() => {
                            window.location.reload()
                        }, 200);
                    }
                }
            });
        });


        document.querySelector('.yes').addEventListener('click', (e) => {
            e.stopImmediatePropagation();
            document.querySelector('.confirm_send_popup').classList.remove('show_confirm_send_popup');
            document.querySelector('.message_popup').classList.add('remove_message_popup');
            document.querySelector('.message_popup').classList.remove('show_message_popup');
            setTimeout(() => {
                document.querySelector('.sending_popup').classList.add('show_sending_popup');
            }, 150);
            
            var addFormData = {
                'phone_numbers': document.querySelector('#phone_no').value,
            };
            var selected_contacts = [];
            document.querySelectorAll('.contact').forEach(contact => {
                if (contact.querySelector('input').checked == true){
                    selected_contacts.push(contact.querySelector('input').value);
                };
            });
            var selectFormData = {
                'all_contacts': document.querySelector('#all').checked,
                'selected_contacts': selected_contacts,
            };
            var messageFormData = {
                'message': document.querySelector('#message').value,
            };
            var payload = {
                'addFormData': addFormData,
                'selectFormData': selectFormData,
                'messageFormData': messageFormData,
                'action': 'send_message',
            };

            var file = document.querySelector('#phone_no_file').files[0];
            var formData = new FormData();
            formData.append('file', file);
            formData.append('payload', JSON.stringify(payload))
            
            // sends data for message to be sent
            $.ajax({
                url: '{% url "send" %}',
                method: 'POST',
                contentType: false,
                dataType: 'json',
                data: formData,
                processData: false,
                cache: false,
                headers: {
                    'X-CSRFToken': getCookie("csrftoken"),
                    'X-Requested-With': 'XMLHttpRequest',
                },
                success: function(data){
                    if (data['success'] == 'true' || 'false'){
                        document.querySelector('.sending_popup').classList.add('remove_sending_popup');
                        document.querySelector('.sending_popup').classList.remove('show_sending_popup');
                        document.querySelector('body').classList.remove('stop_scroll');
                        document.querySelectorAll('button').forEach(button => {
                            button.disabled = false;
                            button.style.pointerEvents = "auto";
                        });
                        setTimeout(() => {
                            window.location.reload()
                        }, 200);
                    }
                }
            });

        });

        document.querySelector('.no').addEventListener('click', (e) => {
            document.querySelector('.confirm_send_popup').classList.remove('show_confirm_send_popup');
            document.querySelector('body').classList.remove('stop_scroll');
        });

        const accept_btn = document.getElementById('accept');
        const decline_btn = document.getElementById('decline');
        if(document.querySelector('.cookie_msg') && !document.querySelector('.cookie_msg').contains(event.target) && !document.querySelector('.cookie_msg').classList.contains('close_cookie')){
            document.querySelector('.cookie_msg').classList.add('close_cookie');
        }
        if (accept_btn && accept_btn.contains(event.target)){
            $.ajax({
                url: "{% url 'use-cookie' %}",
                type: "POST",
                data: {
                    csrfmiddlewaretoken: getCookie('csrftoken'),
                    'choice': 'accept',
                },
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest',
                },
                success: function(response){
                    document.querySelector('.cookie_msg').classList.add('close_cookie');
                }
            });
        }
        else if (decline_btn && decline_btn.contains(event.target)){
            $.ajax({
                url: "{% url 'use-cookie' %}",
                type: "POST",
                data: {
                    csrfmiddlewaretoken: getCookie('csrftoken'),
                    'choice': 'decline',
                },
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest',
                },
                success: function(response){
                    document.querySelector('.cookie_msg').classList.add('close_cookie');
                }
            });
        };
        
 
    };
</script>
{% endblock script %}
</html>